<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <div th:insert="fragments/common :: head('게시판')"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
    <style>
        .container {
            margin-top: 50px;
        }

        h2 {
            margin-bottom: 10px;
        }
    </style>
    <script th:inline="javascript">
        function deletePost(){
            let id=document.getElementById('postId').value;
            let isDelete=confirm("정말 삭제하시겠습니까?");
            if(isDelete){
                return true;
            }else{
                return false;
            }
        }

        function deleteComment(idx){
            if(!confirm('댓글을 삭제하시겠어요?')) {
                return false;
            }

            var post_id=document.getElementById("postId");
            var uri='/comment/delete/' + idx;
            var headers={"Content-Type" : "application/json", "X-HTTP-Method-Override" : "POST"};
            var params = {"post_id" : [[${post.id}]]};

            $.ajax({
                url : uri,
                type : "POST",
                headers : headers,
                data : JSON.stringify(params),
                success : function(response) {
                    window.location.reload();
                    $("#commentModal").modal("hide");
                },
                error : function(xhr, status, error) {
                    alert("에러가 발생하였습니다.");
                    return false;
                }
             });
        }

        function saveComment() {
            if(!isValid("reply")) {
                return false;
            }

            var content = document.getElementById("reply");
            var commentMsg=document.getElementById("reply_msg");
            var post_id=[[${post.id}]];

            var uri = "/comment/write";
            var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override" : "POST"};
            var params = {"comment" : content.value, "post_id" : post_id};

            $.ajax({
                url: uri,
                type: "POST",
                headers : headers,
                data: JSON.stringify(params),
                success: function(response) {
                    if (response.blank == true) {
                        commentMsg.innerHTML="댓글을 작성해주세요.";
                    }else if (response.max == true) {
                        commentMsg.innerHTML="10,000자 이하로 댓글을 작성하세요.";
                    }else {         // 댓글 등록 완료
                        window.location.reload();
                    }
                },
                error: function(xhr, status, error) {
                    alert("에러가 발생하였습니다." + error + status);
                    return false;
                }
            });
        }

        function updateComment(idx) {
            if(!isValid("modalContent")) {
                return false;
            }
            if(!confirm('댓글을 수정하시겠어요?')) {
                return false;
            }

            var content = document.getElementById("modalContent");
            var commentMsg=document.getElementById("check_comment");

            var uri = "/comment/update/" + idx;
            var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override" : "PUT"};
            var params = {"comment" : content.value};

            $.ajax({
                url: uri,
                type: "PUT",
                headers: headers,
                data: JSON.stringify(params),
                success: function(response) {
                    if (response.blank == true) {
                        commentMsg.innerHTML="댓글을 작성해주세요.";
                    }else if (response.max == true) {
                        commentMsg.innerHTML="10,000자 이하로 댓글을 작성하세요.";
                    }else {         // 댓글 수정 완료
                        window.location.reload();
                        $("#commentModal").modal("hide");
                    }
                },
                error: function(xhr, status, error) {
                    alert("에러가 발생하였습니다." + error + status);
                    return false;
                }
            });
        }

        function openModal(idx, writer, content) {

            $("#commentModal").modal("toggle");
            document.getElementById("modalWriter").value = writer;
            document.getElementById("modalContent").value = content;

            document.getElementById("btnCommentUpdate").setAttribute("onclick", "updateComment("+ idx +")");
            document.getElementById("btnCommentDelete").setAttribute("onclick", "deleteComment("+ idx +")");

	}

	function hideModal() {
	    $("#commentModal").modal("hide");
	}

	function isValid(value) {
	    const content=document.getElementById(value);

	    if (!content.value.trim()) {
	        alert('댓글을 입력하세요.');
	        content.focus();
	        return false;
	    }

	    return true;
	}
    </script>
</head>

<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" th:insert="fragments/common :: menu('board')">
</nav>
    <div class="container" th:with="username=${#authentication.name}">
        <div class="card">
            <h2 class="card-header" th:text="${post.title}">제목</h2>
            <span class="card-body text-dark" th:utext="${post.content}"></span>
        </div>

        <form th:method="delete" id="delete" th:action="@{'/post/delete/' + ${post.id}}" onSubmit="return deletePost()">
            <input type="hidden" name="_method" value="delete">
        </form>

        <form th:action="@{/post/update(id=${post.id})}">
            <button type="submit" th:name="id" th:value="${post.id}" class="btn btn-primary float-right mt-3" th:if="${#strings.equals(post.author, username)}">수정</button>
        </form>

        <button type="submit" form="delete" class="btn btn-danger mr-3 float-right mt-3 mb-3" th:if="${#strings.equals(post.author, username)}"><i class="bi bi-trash"></i> 삭제</button>

        <th:block layout:fragment="modal">
            <div id="commentModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="hideModal();">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form method="POST" th:action="@{/comment/write}">
                                <div class="form-group">
                                    <label for="modalWriter" class="col-form-label">작성자</label>
                                    <input type="text" id="modalWriter" class="form-control" disabled/>
                                </div>
                                <div class="form-group">
                                    <label for="modalContent" class="col-form-label">내용</label>
                                    <textarea id="modalContent" class="form-control" maxlength="10000" placeholder="내용을 입력해주세요."></textarea>
                                    <div id="check_comment" class="text-danger"></div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button"  id="btnCommentDelete" class="btn btn-danger waves-effect waves-light" onclick="deleteComment()"><i class="bi bi-trash"></i> 삭제</button>
                            <button type="button" id="btnCommentUpdate" class="btn btn-primary waves-effect waves-light" onclick="updateComment()">수정</button>
                        </div>
                    </div>
                </div>
            </div>
        </th:block>

        <div class="card w-100">
            <div class="card-header bi bi-chat-right-dots"> Write a Comment</div>
            <form method="POST" th:action="@{/comment/write}">
                <input type="hidden" id="post_id" name="post_id" th:value="${post.id}">
                <div class="card-body">
                    <textarea id="reply" name="reply" class="form-control" rows="4" maxlength="10000" placeholder="댓글을 입력하세요"></textarea>
                    <span class="text-danger" id="reply_msg"></span>
                </div>
                <div class="card-footer">
                    <button type="button" id="btn-comment-save" onclick="saveComment()" class="btn btn-outline-primary bi bi-pencil-square">등록</button>
                </div>
            </form>
        </div>

        <div id="commentTable">
            <div class="card-header bi bi-chat-dots mt-3">
                <span th:if=${commentList} th:text="${#lists.size(commentList)}"></span>
                Comments
            </div>
            <div th:each="comment:${commentList}" class="card">
                <ul class="list-group-flush">
                    <li class="list-group-item">
                        <form method="post">
                            <span th:text="${comment.username}" style="font-size: small"> 작성자 </span>
                            <span th:text="${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}" style="font-size: xx-small"> 날짜 </span>
                            </br>
                            <span th:text="${comment.comment}">댓글</span>
                            <button type="button" th:if="${#strings.equals(comment.username, username)}" th:attr="onclick=|openModal('${comment.id}', '${comment.username}', '${comment.comment}' )|" class="bi bi-pencil" style="float : right"></button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>